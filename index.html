// One-page kar/zarar yazılımı
import React, { useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import Papa from "papaparse";

export default function KarZararPaneli() {
  const [gelirler, setGelirler] = useState([]);
  const [giderler, setGiderler] = useState([]);
  const [gelirForm, setGelirForm] = useState({ kanal: "Web Sitesi", ay: "", yil: "", ciro: "", siparis: "", urun: "", urunTutari: "" });
  const [giderForm, setGiderForm] = useState({ kanal: "Web Sitesi", ay: "", yil: "", tur: "", tutar: "", kdv: "", aciklama: "" });

  const handleGelirEkle = () => {
    setGelirler([...gelirler, { ...gelirForm, ciro: parseFloat(gelirForm.ciro) }]);
    setGelirForm({ kanal: "Web Sitesi", ay: "", yil: "", ciro: "", siparis: "", urun: "", urunTutari: "" });
  };

  const handleGiderEkle = () => {
    setGiderler([...giderler, { ...giderForm, tutar: parseFloat(giderForm.tutar) }]);
    setGiderForm({ kanal: "Web Sitesi", ay: "", yil: "", tur: "", tutar: "", kdv: "", aciklama: "" });
  };

  const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
  const yillar = [2023, 2024, 2025];
  const giderTurleri = ["Ürün Maliyeti", "Reklam", "Kargo", "Komisyon", "Operasyon"];

  const handleExcelImport = (e, type) => {
    Papa.parse(e.target.files[0], {
      header: true,
      complete: (results) => {
        const parsedData = results.data.map((item) => ({ ...item, tutar: parseFloat(item.tutar) }));
        if (type === "gelir") setGelirler([...gelirler, ...parsedData]);
        else setGiderler([...giderler, ...parsedData]);
      }
    });
  };

  const hesapla = (kanal) => {
    const kanalGelir = gelirler.filter((g) => g.kanal === kanal).reduce((sum, g) => sum + (parseFloat(g.ciro) || 0), 0);
    const kanalGider = giderler.filter((g) => g.kanal === kanal).reduce((sum, g) => sum + g.tutar, 0);
    let roasDegeri = "-";
    if (kanal === "Web Sitesi") {
      const reklamGideri = giderler.filter((g) => g.kanal === kanal && g.tur === "Reklam").reduce((sum, g) => sum + g.tutar, 0);
      roasDegeri = reklamGideri > 0 ? (kanalGelir / reklamGideri).toFixed(2) : "-";
    }
    return { ciro: kanalGelir, karZarar: kanalGelir - kanalGider, roas: roasDegeri };
  };

  const web = hesapla("Web Sitesi");
  const trendyol = hesapla("Trendyol");
  const toplam = { ciro: web.ciro + trendyol.ciro, karZarar: web.karZarar + trendyol.karZarar, roas: "-" };

  return (
    <div className="grid grid-cols-1 gap-6 p-6">
      <Card>
        <CardContent className="space-y-4">
          <h2 className="text-xl font-bold">Gelir Girişi</h2>
          <select onChange={(e) => setGelirForm({ ...gelirForm, ay: e.target.value })} value={gelirForm.ay}>
            <option value="">Ay Seç</option>
            {aylar.map((ay) => (<option key={ay} value={ay}>{ay}</option>))}
          </select>
          <select onChange={(e) => setGelirForm({ ...gelirForm, yil: e.target.value })} value={gelirForm.yil}>
            <option value="">Yıl Seç</option>
            {yillar.map((y) => (<option key={y} value={y}>{y}</option>))}
          </select>
          <Input placeholder="Ciro" value={gelirForm.ciro} onChange={(e) => setGelirForm({ ...gelirForm, ciro: e.target.value })} />
          <Input placeholder="Sipariş Adedi" value={gelirForm.siparis} onChange={(e) => setGelirForm({ ...gelirForm, siparis: e.target.value })} />
          <Input placeholder="Ürün Adedi" value={gelirForm.urun} onChange={(e) => setGelirForm({ ...gelirForm, urun: e.target.value })} />
          <Input placeholder="Ürün Tutarı" value={gelirForm.urunTutari} onChange={(e) => setGelirForm({ ...gelirForm, urunTutari: e.target.value })} />
          <RadioGroup value={gelirForm.kanal} onValueChange={(val) => setGelirForm({ ...gelirForm, kanal: val })}>
            <RadioGroupItem value="Web Sitesi" id="gelir-web" /> <Label htmlFor="gelir-web">Web Sitesi</Label>
            <RadioGroupItem value="Trendyol" id="gelir-trendyol" /> <Label htmlFor="gelir-trendyol">Trendyol</Label>
          </RadioGroup>
          <Button onClick={handleGelirEkle}>Ekle</Button>
          <Input type="file" accept=".csv" onChange={(e) => handleExcelImport(e, "gelir")} />
        </CardContent>
      </Card>

      <Card>
        <CardContent className="space-y-4">
          <h2 className="text-xl font-bold">Gider Girişi</h2>
          <select onChange={(e) => setGiderForm({ ...giderForm, ay: e.target.value })} value={giderForm.ay}>
            <option value="">Ay Seç</option>
            {aylar.map((ay) => (<option key={ay} value={ay}>{ay}</option>))}
          </select>
          <select onChange={(e) => setGiderForm({ ...giderForm, yil: e.target.value })} value={giderForm.yil}>
            <option value="">Yıl Seç</option>
            {yillar.map((y) => (<option key={y} value={y}>{y}</option>))}
          </select>
          <select onChange={(e) => setGiderForm({ ...giderForm, tur: e.target.value })} value={giderForm.tur}>
            <option value="">Gider Türü</option>
            {giderTurleri.map((tur) => (<option key={tur} value={tur}>{tur}</option>))}
          </select>
          <Input placeholder="Tutar" value={giderForm.tutar} onChange={(e) => setGiderForm({ ...giderForm, tutar: e.target.value })} />
          <select onChange={(e) => setGiderForm({ ...giderForm, kdv: e.target.value })} value={giderForm.kdv}>
            <option value="">KDV Seç</option>
            <option value="0">%0</option>
            <option value="10">%10</option>
            <option value="20">%20</option>
            <option value="100">%100</option>
          </select>
          <Input placeholder="Açıklama" value={giderForm.aciklama} onChange={(e) => setGiderForm({ ...giderForm, aciklama: e.target.value })} />
          <RadioGroup value={giderForm.kanal} onValueChange={(val) => setGiderForm({ ...giderForm, kanal: val })}>
            <RadioGroupItem value="Web Sitesi" id="gider-web" /> <Label htmlFor="gider-web">Web Sitesi</Label>
            <RadioGroupItem value="Trendyol" id="gider-trendyol" /> <Label htmlFor="gider-trendyol">Trendyol</Label>
            <RadioGroupItem value="Operasyonel Giderler" id="gider-op" /> <Label htmlFor="gider-op">Operasyonel Giderler</Label>
            <RadioGroupItem value="Vergi" id="gider-vergi" /> <Label htmlFor="gider-vergi">Vergi</Label>
          </RadioGroup>
          <Button onClick={handleGiderEkle}>Ekle</Button>
          <Input type="file" accept=".csv" onChange={(e) => handleExcelImport(e, "gider")} />
        </CardContent>
      </Card>

      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-4">Özet</h2>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Kanal</TableHead>
                <TableHead>Ciro</TableHead>
                <TableHead>Kar / Zarar</TableHead>
                <TableHead>ROAS</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              <TableRow>
                <TableCell>Web Sitesi</TableCell>
                <TableCell>{web.ciro.toFixed(2)} TL</TableCell>
                <TableCell>{web.karZarar.toFixed(2)} TL</TableCell>
                <TableCell>{web.roas}</TableCell>
              </TableRow>
              <TableRow>
                <TableCell>Trendyol</TableCell>
                <TableCell>{trendyol.ciro.toFixed(2)} TL</TableCell>
                <TableCell>{trendyol.karZarar.toFixed(2)} TL</TableCell>
                <TableCell>-</TableCell>
              </TableRow>
              <TableRow className="font-bold">
                <TableCell>Toplam</TableCell>
                <TableCell>{toplam.ciro.toFixed(2)} TL</TableCell>
                <TableCell>{toplam.karZarar.toFixed(2)} TL</TableCell>
                <TableCell>{toplam.roas}</TableCell>
              </TableRow>
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}
